<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Data Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .select-container {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }
        select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            background: white;
            font-size: 0.9em;
            min-width: 200px;
            transition: border-color 0.3s ease;
        }
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        .content-area {
            display: flex;
            gap: 20px;
            padding: 30px;
        }
        .chart-container {
            flex: 2;
            position: relative;
            height: 500px;
        }
        .details-container {
            flex: 1;
            min-width: 300px;
            max-width: 350px; /* Limit the width */
        }
        .activity-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px; /* Reduced padding */
            border: 1px solid #e9ecef;
            max-height: 500px; /* Limit height */
            overflow-y: auto; /* Add scrolling if needed */
        }
        .activity-details h3 {
            margin-top: 0;
            margin-bottom: 15px; /* Reduced margin */
            color: #495057;
            font-size: 1.1em; /* Slightly smaller font */
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px; /* Reduced padding */
        }
        .details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em; /* Smaller font size */
        }
        .details-table tr:nth-child(even) {
            background-color: #ffffff;
        }
        .details-table td {
            padding: 6px 8px; /* Reduced padding */
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
            line-height: 1.3; /* Tighter line height */
        }
        .details-table td:first-child {
            font-weight: 600;
            color: #495057;
            width: 45%; /* Adjusted width ratio */
            font-size: 0.8em; /* Even smaller for labels */
        }
        .details-table td:last-child {
            color: #6c757d;
            word-break: break-word; /* Break long words */
        }

        /* Make the table collapsible on smaller screens */
        @media (max-width: 1200px) {
            .details-container {
                max-width: 300px;
            }
            .activity-details {
                padding: 12px;
            }
            .details-table {
                font-size: 0.8em;
            }
            .details-table td {
                padding: 4px 6px;
            }
        }
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.2em;
        }
        .error {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }
        .speed { background-color: #ff6b6b; }
        .incline { background-color: #4ecdc4; }
        .heart-rate { background-color: #45b7d1; }

        @media (max-width: 768px) {
            .select-container {
                flex-direction: column;
                align-items: flex-start;
            }
            select {
                min-width: 100%;
            }
            .header h1 {
                font-size: 2em;
            }
            .legend {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
        }

        @media (max-width: 1024px) {
            .content-area {
                flex-direction: column;
            }
            .chart-container {
                flex: none;
                height: 400px;
            }
            .details-container {
                flex: none;
                min-width: auto;
                max-width: none;
            }
            .activity-details {
                max-height: 200px; /* Smaller height on mobile */
            }
        }

        @media (max-width: 768px) {
            .select-container {
                flex-direction: column;
                align-items: flex-start;
            }
            select {
                min-width: 100%;
            }
            .header h1 {
                font-size: 2em;
            }
            .legend {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            .content-area {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Activity Data Visualization</h1>
        </div>

        <div class="controls">
            <div class="select-container">
                <select id="activitySelect">
                    <option value="">Choose an activity...</option>
                </select>

                <select id="smoothingSelect">
                    <option value="1">No smoothing (1 sample)</option>
                    <option value="2" selected>Light smoothing (2 samples)</option>
                    <option value="3">Medium smoothing (3 samples)</option>
                    <option value="4">Heavy smoothing (4 samples)</option>
                    <option value="5">Very heavy smoothing (5 samples)</option>
                    <option value="10">Maximum smoothing (10 samples)</option>
                </select>
            </div>
        </div>

        <div class="error" id="errorMessage"></div>
        <div class="loading" id="loading">Loading chart data...</div>

        <div class="content-area">
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>

            <div class="details-container">
                <div class="activity-details" id="activityDetails" style="display: none;">
                    <h3 onclick="toggleDetails()" style="cursor: pointer; user-select: none;">
                        Activity Details
                        <span id="toggleIcon" style="float: right; font-size: 0.8em;">â–¼</span>
                    </h3>
                    <div id="detailsContent">
                        <table class="details-table" id="detailsTable">
                            <!-- Activity details will be populated here -->
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color speed"></div>
                <span>Speed (km/h)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color incline"></div>
                <span>Incline (%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color heart-rate"></div>
                <span>Heart Rate (bpm)</span>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let selectedActivityName = null;

        // Load activities when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadActivities();
            
            // Add event listener for smoothing selection
            const smoothingSelect = document.getElementById('smoothingSelect');
            smoothingSelect.addEventListener('change', function() {
                // Reload chart data with new smoothing if an activity is selected
                const activitySelect = document.getElementById('activitySelect');
                if (activitySelect.value && selectedActivityName) {
                    loadActivityData(activitySelect.value);
                }
            });
        });

        async function loadActivities() {
            try {
                const response = await fetch('/api/activities');
                const activities = await response.json();

                console.log('Activities response:', activities); // Debug output

                if (!response.ok) {
                    throw new Error(activities.error || 'Failed to fetch activities');
                }

                if (!Array.isArray(activities)) {
                    throw new Error('Expected array of activities, got: ' + typeof activities);
                }

                const select = document.getElementById('activitySelect');
                select.innerHTML = '<option value="">Choose an activity...</option>';

                activities.forEach(activity => {
                    const option = document.createElement('option');
                    option.value = activity.tcxid;
                    option.textContent = activity.display_name;
                    select.appendChild(option);
                });

                // Add event listener for activity selection
                select.addEventListener('change', function() {
                    if (this.value) {
                        // Store the selected activity's display name
                        selectedActivityName = this.options[this.selectedIndex].textContent;
                        loadActivityData(this.value);
                        loadActivityDetails(this.value);
                    } else {
                        selectedActivityName = null;
                        if (chart) {
                            chart.destroy();
                            chart = null;
                        }
                        hideActivityDetails();
                    }
                });

            } catch (error) {
                console.error('Error loading activities:', error);
                showError('Failed to load activities: ' + error.message);
            }
        }

        async function loadActivityData(tcxid) {
            showLoading(true);
            hideError();

            try {
                const smoothingValue = document.getElementById('smoothingSelect').value;
                const response = await fetch(`/api/activity_data/${tcxid}?smoothing=${smoothingValue}`);
                const data = await response.json();

                if (response.ok) {
                    createChart(data);
                } else {
                    showError(data.error || 'Failed to load activity data');
                }

            } catch (error) {
                showError('Failed to load activity data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function loadActivityDetails(tcxid) {
            try {
                console.log('Loading activity details for tcxid:', tcxid); // Debug log
                const response = await fetch(`/api/activity_details/${tcxid}`);
                const details = await response.json();

                console.log('Activity details response:', response.status, details); // Debug log

                if (response.ok) {
                    displayActivityDetails(details);
                } else {
                    console.error('Failed to load activity details:', details.error);
                    // Don't show error for details - it's supplementary information
                }

            } catch (error) {
                console.error('Failed to load activity details:', error.message);
                // Don't show error for details - it's supplementary information
            }
        }

        function toggleDetails() {
            const content = document.getElementById('detailsContent');
            const icon = document.getElementById('toggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¶';
            }
        }

        function displayActivityDetails(details) {
            console.log('Displaying activity details:', details); // Debug log
            const detailsContainer = document.getElementById('activityDetails');
            const detailsTable = document.getElementById('detailsTable');

            // Clear existing content
            detailsTable.innerHTML = '';

            // Check if we have any details to display
            if (Object.keys(details).length === 0) {
                console.log('No details to display');
                detailsContainer.style.display = 'none';
                return;
            }

            // Populate table with details - prioritize most important info first
            const priorityOrder = [
                'Sport', 'Total Time', 'Distance', 'Maximum Speed', 
                'Average Heart Rate', 'Maximum Heart Rate', 'Calories',
                'Start Time', 'Intensity', 'Notes'
            ];

            // Add priority items first
            priorityOrder.forEach(key => {
                if (details[key]) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${key}</td>
                        <td>${details[key]}</td>
                    `;
                    detailsTable.appendChild(row);
                }
            });

            // Add any remaining items
            Object.entries(details).forEach(([key, value]) => {
                if (!priorityOrder.includes(key)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${key}</td>
                        <td>${value}</td>
                    `;
                    detailsTable.appendChild(row);
                }
            });

            // Show the details container
            detailsContainer.style.display = 'block';
            
            // Make sure the content is initially visible
            document.getElementById('detailsContent').style.display = 'block';
            document.getElementById('toggleIcon').textContent = 'â–¼';
            
            console.log('Details container shown');
        }

        function hideActivityDetails() {
            const detailsContainer = document.getElementById('activityDetails');
            detailsContainer.style.display = 'none';
        }

        function createChart(data) {
            const ctx = document.getElementById('activityChart').getContext('2d');

            // Convert seconds to mm:ss format for display
            const formattedLabels = data.labels.map(seconds => {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            });

            // Calculate min and max heart rate values, starting from the 10th valid reading
            const heartRateValues = data.heart_rate.filter(value => value !== null && value !== undefined && value > 0);
            const heartRateValuesFromTenth = heartRateValues.slice(9); // Skip first 9 values (0-indexed)
            
            let minHeartRate, maxHeartRate;
            if (heartRateValuesFromTenth.length > 0) {
                minHeartRate = Math.min(...heartRateValuesFromTenth);
                maxHeartRate = Math.max(...heartRateValuesFromTenth);
            } else {
                // Fallback if there aren't enough readings
                minHeartRate = heartRateValues.length > 0 ? Math.min(...heartRateValues) : 0;
                maxHeartRate = heartRateValues.length > 0 ? Math.max(...heartRateValues) : 0;
            }

            // Destroy existing chart if it exists
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedLabels,
                    datasets: [
                        {
                            label: 'Speed (km/h)',
                            data: data.speed,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Incline (%)',
                            data: data.incline,
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Heart Rate (bpm)',
                            data: data.heart_rate,
                            borderColor: '#45b7d1',
                            backgroundColor: 'rgba(69, 183, 209, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: selectedActivityName || 'Activity Metrics Over Time',
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        legend: {
                            display: false // We have custom legend
                        },
                        annotation: {
                            annotations: {
                                maxHeartRateLine: {
                                    type: 'line',
                                    scaleID: 'y2',
                                    value: maxHeartRate,
                                    borderColor: '#45b7d1',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: `Max HR: ${Math.round(maxHeartRate)} bpm`,
                                        position: 'start',
                                        backgroundColor: '#45b7d1',
                                        color: 'white',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        },
                                        padding: 4
                                    }
                                },
                                minHeartRateLine: {
                                    type: 'line',
                                    scaleID: 'y2',
                                    value: minHeartRate,
                                    borderColor: '#45b7d1',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: `Min HR: ${Math.round(minHeartRate)} bpm`,
                                        position: 'start',
                                        backgroundColor: '#45b7d1',
                                        color: 'white',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        },
                                        padding: 4
                                    }
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 2) { // Heart Rate dataset
                                        label += Math.round(context.parsed.y) + ' bpm';
                                    } else {
                                        label += context.parsed.y;
                                        if (context.datasetIndex === 0) {
                                            label += ' km/h';
                                        } else if (context.datasetIndex === 1) {
                                            label += '%';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time (mm:ss)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            title: {
                                display: true,
                                text: 'Speed (km/h)',
                                color: '#ff6b6b',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#ff6b6b'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Incline (%)',
                                color: '#4ecdc4',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#4ecdc4'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: false, // Hide this axis since we can't show 3 y-axes nicely
                            position: 'right'
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                plugins: [window['chartjs-plugin-annotation']]
            });
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
        }
    </script>
</body>
</html>
